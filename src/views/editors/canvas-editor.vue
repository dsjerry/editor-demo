<template>
    <div>
        <Navigation />
        <div class="canvas-editor-container">
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="executeCommand('undo')" title="æ’¤é”€">
                        <i class="icon-undo"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('redo')" title="é‡åš">
                        <i class="icon-redo"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="executeCommand('bold')" title="åŠ ç²—">
                        <i class="icon-bold"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('italic')" title="æ–œä½“">
                        <i class="icon-italic"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('underline')" title="ä¸‹åˆ’çº¿">
                        <i class="icon-underline"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="executeCommand('justifyLeft')" title="å·¦å¯¹é½">
                        <i class="icon-align-left"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('justifyCenter')" title="å±…ä¸­å¯¹é½">
                        <i class="icon-align-center"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('justifyRight')" title="å³å¯¹é½">
                        <i class="icon-align-right"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('heading', 1)" title="æ ‡é¢˜1">H1</button>
                    <button class="toolbar-btn" @click="insertElement('heading', 2)" title="æ ‡é¢˜2">H2</button>
                    <button class="toolbar-btn" @click="insertElement('heading', 3)" title="æ ‡é¢˜3">H3</button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('list', 'unordered')" title="æ— åºåˆ—è¡¨">
                        <i class="icon-list-ul"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('list', 'ordered')" title="æœ‰åºåˆ—è¡¨">
                        <i class="icon-list-ol"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('table')" title="æ’å…¥è¡¨æ ¼">
                        <i class="icon-table"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('image')" title="æ’å…¥å›¾ç‰‡">
                        <i class="icon-image"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('link')" title="æ’å…¥é“¾æ¥">
                        <i class="icon-link"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('barcode1d')" title="æ’å…¥æ¡å½¢ç ">
                        <i class="icon-barcode"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('barcode2d')" title="æ’å…¥äºŒç»´ç ">
                        <i class="icon-qrcode"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('codeblock')" title="æ’å…¥ä»£ç å—">
                        <i class="icon-code"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('pageBreak')" title="æ’å…¥åˆ†é¡µç¬¦">
                        <i class="icon-page-break"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('datePicker')" title="æ’å…¥æ—¥æœŸé€‰æ‹©å™¨">
                        <i class="icon-calendar"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('diagram')" title="æ’å…¥æµç¨‹å›¾">
                        <i class="icon-diagram"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="insertElement('radio')" title="æ’å…¥å•é€‰æ¡†">
                        <i class="icon-radio"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('checkbox')" title="æ’å…¥å¤é€‰æ¡†">
                        <i class="icon-checkbox"></i>
                    </button>
                    <button class="toolbar-btn" @click="insertElement('input')" title="æ’å…¥æ–‡æœ¬æ¡†">
                        <i class="icon-input"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="importDocument('docx')" title="å¯¼å…¥Word">
                        <i class="icon-file-word"></i>
                    </button>
                    <button class="toolbar-btn" @click="importDocument('excel')" title="å¯¼å…¥Excel">
                        <i class="icon-file-excel"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="exportDocument('docx')" title="å¯¼å‡ºWord">
                        <i class="icon-file-word"></i>
                    </button>
                    <button class="toolbar-btn" @click="exportDocument('pdf')" title="å¯¼å‡ºPDF">
                        <i class="icon-file-pdf"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="executeCommand('upperCase')" title="è½¬æˆå¤§å†™">
                        <i class="icon-uppercase"></i>
                    </button>
                    <button class="toolbar-btn" @click="executeCommand('lowerCase')" title="è½¬æˆå°å†™">
                        <i class="icon-lowercase"></i>
                    </button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" @click="toggleMode()" title="åˆ‡æ¢ç¼–è¾‘/åªè¯»æ¨¡å¼">
                        <i class="icon-mode"></i>
                    </button>
                </div>
            </div>
            
            <!-- ä¸‰æ å¸ƒå±€ -->
            <div class="editor-content">
                <!-- å·¦ä¾§ç›®å½•æ  -->
                <div class="sidebar-left">
                    <div class="sidebar-header">
                        <h3>ç›®å½•</h3>
                    </div>
                    <div class="toc-container">
                        <ul class="toc-list">
                            <li v-for="(item, index) in tableOfContents" :key="index" 
                                :class="'toc-item toc-level-' + item.level"
                                @click="scrollToHeading(item.id)">
                                {{ item.text }}
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- ä¸­é—´ç¼–è¾‘å™¨æ  -->
                <div class="editor-main">
                    <div class="editor"></div>
                    <div class="editor-statusbar">
                        <span class="status-item">å­—æ•°: {{ wordCount }}</span>
                        <span class="status-item">é¡µæ•°: {{ pageCount }}</span>
                        <span class="status-item">å½“å‰é¡µ: {{ currentPage }}</span>
                    </div>
                </div>
                
                <!-- å³ä¾§æ‰¹æ³¨æ  -->
                <div class="sidebar-right">
                    <div class="sidebar-header">
                        <h3>æ‰¹æ³¨</h3>
                    </div>
                    <div class="comments-container">
                        <p>æ‰¹æ³¨åŠŸèƒ½å¼€å‘ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { onMounted, ref, reactive } from 'vue';
import Navigation from '../../components/Navigation.vue';

let editorInstance = null;
import { Editor, ElementType } from '@hufe921/canvas-editor';
import barcode1dPlugin from '@hufe921/canvas-editor-plugin-barcode1d';
import barcode2dPlugin from '@hufe921/canvas-editor-plugin-barcode2d';
import codeblockPlugin from '@hufe921/canvas-editor-plugin-codeblock';
import docxPlugin from '@hufe921/canvas-editor-plugin-docx';
import excelPlugin from '@hufe921/canvas-editor-plugin-excel';
import floatingToolbarPlugin from '@hufe921/canvas-editor-plugin-floating-toolbar';
import diagramPlugin from '@hufe921/canvas-editor-plugin-diagram';
import casePlugin from '@hufe921/canvas-editor-plugin-case';

// çŠ¶æ€ç®¡ç†
const wordCount = ref(0);
const pageCount = ref(1);
const currentPage = ref(1);
const editorStatus = reactive({
    isDirty: false,
    isLoading: true,
    mode: 'edit' // edit æˆ– readonly
});

// ç›®å½•æ•°æ®
const tableOfContents = ref([]);

// æ‰§è¡Œç¼–è¾‘å™¨å‘½ä»¤
function executeCommand(command) {
    if (!editorInstance) return;

    switch (command) {
        case 'undo':
            editorInstance.command.executeUndo();
            break;
        case 'redo':
            editorInstance.command.executeRedo();
            break;
        case 'bold':
            editorInstance.command.executeBold();
            break;
        case 'italic':
            editorInstance.command.executeItalic();
            break;
        case 'underline':
            editorInstance.command.executeUnderline();
            break;
        case 'justifyLeft':
            editorInstance.command.executeAlignment('left');
            break;
        case 'justifyCenter':
            editorInstance.command.executeAlignment('center');
            break;
        case 'justifyRight':
            editorInstance.command.executeAlignment('right');
            break;
        case 'upperCase':
            editorInstance.command.executeUpperCase();
            break;
        case 'lowerCase':
            editorInstance.command.executeLowerCase();
            break;
    }

    editorStatus.isDirty = true;
    updateStatus();
}

// æ’å…¥å…ƒç´ 
function insertElement(type, subtype) {
    if (!editorInstance) return;

    switch (type) {
        case 'heading':
            editorInstance.command.executeHeading(subtype);
            break;
        case 'list':
            if (subtype === 'unordered') {
                editorInstance.command.executeList('unordered');
            } else {
                editorInstance.command.executeList('ordered');
            }
            break;
        case 'table':
            editorInstance.command.executeInsertTable(3, 3);
            break;
        case 'image':
            const imageUrl = window.prompt('è¯·è¾“å…¥å›¾ç‰‡URL');
            if (imageUrl) {
                editorInstance.command.executeInsertImage(imageUrl);
            }
            break;
        case 'link':
            const linkUrl = window.prompt('è¯·è¾“å…¥é“¾æ¥URL');
            const linkText = window.prompt('è¯·è¾“å…¥é“¾æ¥æ–‡æœ¬');
            if (linkUrl && linkText) {
                editorInstance.command.executeInsertLink(linkUrl, linkText);
            }
            break;
        case 'barcode1d':
            const barcode1dContent = window.prompt('è¯·è¾“å…¥æ¡å½¢ç å†…å®¹');
            if (barcode1dContent) {
                editorInstance.command.executeInsertBarcode1D(barcode1dContent, 200, 100);
            }
            break;
        case 'barcode2d':
            const barcode2dContent = window.prompt('è¯·è¾“å…¥äºŒç»´ç å†…å®¹');
            if (barcode2dContent) {
                editorInstance.command.executeInsertBarcode2D(barcode2dContent, 200, 200);
            }
            break;
        case 'codeblock':
            const codeContent = window.prompt('è¯·è¾“å…¥ä»£ç å†…å®¹');
            const language = window.prompt('è¯·è¾“å…¥ç¼–ç¨‹è¯­è¨€ (å¦‚: javascript, python, html)');
            if (codeContent && language) {
                editorInstance.command.executeInsertCodeblock(codeContent, language);
            }
            break;
        case 'pageBreak':
            editorInstance.command.executeInsertPageBreak();
            break;
        case 'datePicker':
            editorInstance.command.executeInsertDatePicker();
            break;
        case 'diagram':
            editorInstance.command.executeLoadDiagram({
                data: '',
                onDestroy: message => {
                    if (!message || !message.data) return;
                    const { bounds } = message;
                    editorInstance.command.executeInsertElementList([
                        {
                            type: ElementType.IMAGE,
                            width: bounds.width,
                            height: bounds.height,
                            value: message.data,
                            extension: {
                                name: 'diagram',
                                xml: message.xml
                            }
                        }
                    ]);
                }
            });
            break;
        case 'radio':
            const radioOptions = window.prompt('è¯·è¾“å…¥é€‰é¡¹ï¼Œç”¨é€—å·åˆ†éš” (å¦‚: é€‰é¡¹1,é€‰é¡¹2,é€‰é¡¹3)');
            if (radioOptions) {
                const radioOptionList = radioOptions.split(',');
                editorInstance.command.executeInsertRadio(radioOptionList);
            }
            break;
        case 'checkbox':
            const checkboxOptions = window.prompt('è¯·è¾“å…¥é€‰é¡¹ï¼Œç”¨é€—å·åˆ†éš” (å¦‚: é€‰é¡¹1,é€‰é¡¹2,é€‰é¡¹3)');
            if (checkboxOptions) {
                const checkboxOptionList = checkboxOptions.split(',');
                editorInstance.command.executeInsertCheckbox(checkboxOptionList);
            }
            break;
        case 'input':
            const placeholder = window.prompt('è¯·è¾“å…¥å ä½ç¬¦æ–‡æœ¬');
            editorInstance.command.executeInsertInput(placeholder);
            break;
    }

    editorStatus.isDirty = true;
    updateStatus();
}

// å¯¼å‡ºæ–‡æ¡£
function exportDocument(format) {
    if (!editorInstance) return;

    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');

    if (format === 'docx') {
        editorInstance.command.executeExportDocx({
            fileName: `canvas-editor-${timestamp}.docx`
        });
    } else if (format === 'pdf') {
        editorInstance.command.executePrint({
            fileName: `canvas-editor-${timestamp}.pdf`
        });
    }
}

// å¯¼å…¥æ–‡æ¡£
function importDocument(format) {
    if (!editorInstance) return;

    if (format === 'docx') {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.docx';
        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                editorInstance.command.executeImportDocx({
                    file
                });
            }
        };
        input.click();
    } else if (format === 'excel') {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                editorInstance.command.executeImportExcel({
                    file
                });
            }
        };
        input.click();
    }
}

// åˆ‡æ¢ç¼–è¾‘/åªè¯»æ¨¡å¼
function toggleMode() {
    if (!editorInstance) return;
    
    editorStatus.mode = editorStatus.mode === 'edit' ? 'readonly' : 'edit';
    editorInstance.command.executeSetMode(editorStatus.mode);
}



onMounted(() => {
    const instance = new Editor(
        document.querySelector('.editor'),
        [
            {
                value: 'Canvas Editor - åŸºäºcanvas/svgçš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨',
                type: ElementType.HEADING,
                level: 1,
                style: {
                    textAlign: 'center',
                    color: '#1976d2'
                }
            },
            {
                value: '\n\n'
            },
            {
                value: 'åŠŸèƒ½ç‰¹ç‚¹ï¼š',
                type: ElementType.HEADING,
                level: 2
            },
            {
                value: '\n\n'
            },
            {
                value: '1. å¯Œæ–‡æœ¬æ“ä½œï¼šæ”¯æŒæ’¤é”€ã€é‡åšã€å­—ä½“ã€å­—å·ã€åŠ ç²—ã€æ–œä½“ã€ä¸Šä¸‹æ ‡ã€å¯¹é½æ–¹å¼ã€æ ‡é¢˜ã€åˆ—è¡¨ç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '2. æ’å…¥å…ƒç´ ï¼šæ”¯æŒè¡¨æ ¼ã€å›¾ç‰‡ã€é“¾æ¥ã€ä»£ç å—ã€åˆ†é¡µç¬¦ã€æ—¥æœŸé€‰æ‹©å™¨ã€å†…å®¹å—ç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '3. å³é”®èœå•ï¼šå¯æ’å…¥æ¡å½¢ç ã€äºŒç»´ç ã€ä»£ç å—ã€å¯¼å‡º/å¯¼å…¥æ–‡æ¡£ç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '4. æ‰“å°åŠŸèƒ½ï¼šåŸºäºcanvasè½¬å›¾ç‰‡ã€PDFç»˜åˆ¶',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '5. æ§ä»¶æ”¯æŒï¼šå•é€‰ã€æ–‡æœ¬ã€å¤é€‰æ¡†ç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '6. æ‹–æ‹½åŠŸèƒ½ï¼šæ–‡å­—ã€å…ƒç´ ã€æ§ä»¶æ‹–æ‹½',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '7. é¡µé¢è®¾ç½®ï¼šé¡µçœ‰ã€é¡µè„šã€é¡µç ã€é¡µè¾¹è·ã€æ°´å°ã€åˆ†é¡µç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '8. å¿«æ·é”®ï¼šå†…éƒ¨å¿«æ·é”®å’Œè‡ªå®šä¹‰å¿«æ·é”®',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: '9. å…¶ä»–åŠŸèƒ½ï¼šé€‰æ‹©æ–‡æœ¬æŸ¥çœ‹æ‚¬æµ®å·¥å…·æ ã€å¤§å°å†™è½¬æ¢ã€æµç¨‹å›¾ç»˜åˆ¶ç­‰',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'ä½¿ç”¨è¯´æ˜ï¼š',
                type: ElementType.HEADING,
                level: 2
            },
            {
                value: '\n\n'
            },
            {
                value: 'å³é”®ç‚¹å‡»ç¼–è¾‘å™¨åŒºåŸŸå¯ä»¥æŸ¥çœ‹æ›´å¤šåŠŸèƒ½é€‰é¡¹ï¼ŒåŒ…æ‹¬æ’å…¥æ¡å½¢ç ã€äºŒç»´ç ã€ä»£ç å—ã€å¯¼å‡º/å¯¼å…¥æ–‡æ¡£ç­‰ã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'é€‰æ‹©æ–‡æœ¬å¯ä»¥æŸ¥çœ‹æ‚¬æµ®å·¥å…·æ ï¼Œè¿›è¡Œæ–‡æœ¬æ ¼å¼åŒ–æ“ä½œã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'æ”¯æŒæ‹–æ‹½æ–‡å­—ã€å…ƒç´ å’Œæ§ä»¶ã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'å¯ä»¥æ’å…¥åˆ†é¡µç¬¦ã€æ—¥æœŸé€‰æ‹©å™¨ç­‰å†…å®¹å—ã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'æ”¯æŒè®¾ç½®é¡µçœ‰ã€é¡µè„šã€é¡µç ã€é¡µè¾¹è·ã€æ°´å°ç­‰é¡µé¢å±æ€§ã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'å¯ä»¥å¯¼å‡ºä¸ºPDFæˆ–ç›´æ¥æ‰“å°ã€‚',
                type: ElementType.PARAGRAPH
            },
            {
                value: '\n\n'
            },
            {
                value: 'ä»£ç å—ç¤ºä¾‹ï¼š',
                type: ElementType.HEADING,
                level: 2
            },
            {
                value: '\n\n'
            },
            {
                type: ElementType.CODEBLOCK,
                language: 'javascript',
                value: `// Canvas Editor ä½¿ç”¨ç¤ºä¾‹
import { Editor } from '@hufe921/canvas-editor';

const instance = new Editor(container, [
    {
        value: 'Hello World',
        type: 'paragraph'
    }
], {
    mode: 'edit',
    locale: 'zhCN'
});`
            },
            {
                value: '\n\n'
            },
            {
                value: 'è¡¨æ ¼ç¤ºä¾‹ï¼š',
                type: ElementType.HEADING,
                level: 2
            },
            {
                value: '\n\n'
            },
            {
                value: 'è¡¨æ ¼ç¤ºä¾‹ï¼š\n\nåŠŸèƒ½ | æè¿°\nå¯Œæ–‡æœ¬ç¼–è¾‘ | æ”¯æŒå¤šç§æ–‡æœ¬æ ¼å¼å’Œæ ·å¼\næ’ä»¶ç³»ç»Ÿ | æ”¯æŒå¤šç§æ’ä»¶æ‰©å±•åŠŸèƒ½\n',
                type: ElementType.PARAGRAPH
            }
        ],
        {
            mode: "edit",
            locale: "zhCN",
            defaultType: "TEXT",
            defaultColor: "#000000",
            defaultFont: "Microsoft YaHei",
            defaultSize: 16,
            minSize: 5,
            maxSize: 72,
            defaultRowMargin: 1,
            defaultBasicRowMarginHeight: 8,
            defaultTabWidth: 32,
            width: 794,
            height: 1123,
            scale: 1,
            pageGap: 20,
            underlineColor: "#000000",
            strikeoutColor: "#FF0000",
            rangeAlpha: 0.6,
            rangeColor: "#AECBFA",
            rangeMinWidth: 5,
            searchMatchAlpha: 0.6,
            searchMatchColor: "#FFFF00",
            searchNavigateMatchColor: "#AAD280",
            highlightAlpha: 0.6,
            highlightMarginHeight: 8,
            resizerColor: "#4182D9",
            resizerSize: 5,
            marginIndicatorSize: 35,
            marginIndicatorColor: "#BABABA",
            margins: [100, 120, 100, 120],
            pageMode: "paging",
            renderMode: "speed",
            defaultHyperlinkColor: "#0000FF",
            paperDirection: "vertical",
            inactiveAlpha: 0.6,
            historyMaxRecordCount: 100,
            wordBreak: "break-word",
            printPixelRatio: 3,
            maskMargin: [60, 0, 30, 0],
            letterClass: ["A-Za-z"],
            contextMenuDisableKeys: [],
            shortcutDisableKeys: [],
            scrollContainerSelector: "",
            pageOuterSelectionDisable: false,
            watermark: {
                data: "CANVAS-EDITOR",
                type: "text",
                width: 0,
                height: 0,
                color: "#AEB5C0",
                opacity: 0.3,
                size: 120,
                font: "Microsoft YaHei",
                repeat: false,
                gap: [10, 10],
                numberType: "arabic"
            },
            pageNumber: {
                bottom: 60,
                size: 12,
                font: "Microsoft YaHei",
                color: "#000000",
                rowFlex: "center",
                format: "ç¬¬{pageNo}é¡µ/å…±{pageCount}é¡µ",
                numberType: "arabic",
                disabled: false,
                startPageNo: 1,
                fromPageNo: 0,
                maxPageNo: null
            },
            placeholder: {
                data: "è¯·è¾“å…¥æ­£æ–‡",
                color: "#DCDFE6",
                opacity: 1,
                size: 16,
                font: "Microsoft YaHei"
            },
            zone: {
                tipDisabled: false
            },
            table: {
                tdPadding: [0, 5, 5, 5],
                defaultTrMinHeight: 42,
                defaultColMinWidth: 40,
                defaultBorderColor: "#000000",
                overflow: true
            },
            header: {
                top: 30,
                inactiveAlpha: 1,
                maxHeightRadio: "half",
                disabled: false,
                editable: true
            },
            footer: {
                bottom: 30,
                inactiveAlpha: 1,
                maxHeightRadio: "half",
                disabled: false,
                editable: true
            },
            control: {
                placeholderColor: "#9c9b9b",
                bracketColor: "#000000",
                prefix: "{",
                postfix: "}",
                borderWidth: 1,
                borderColor: "#000000",
                activeBackgroundColor: "",
                disabledBackgroundColor: "",
                existValueBackgroundColor: "",
                noValueBackgroundColor: ""
            },
            checkbox: {
                width: 14,
                height: 14,
                gap: 5,
                lineWidth: 1,
                fillStyle: "#5175f4",
                strokeStyle: "#ffffff",
                verticalAlign: "bottom"
            },
            radio: {
                width: 14,
                height: 14,
                gap: 5,
                lineWidth: 1,
                fillStyle: "#5175f4",
                strokeStyle: "#000000",
                verticalAlign: "bottom"
            },
            cursor: {
                width: 1,
                color: "#000000",
                dragWidth: 2,
                dragColor: "#0000FF",
                dragFloatImageDisabled: false
            },
            title: {
                defaultFirstSize: 26,
                defaultSecondSize: 24,
                defaultThirdSize: 22,
                defaultFourthSize: 20,
                defaultFifthSize: 18,
                defaultSixthSize: 16
            },
            group: {
                opacity: 0.1,
                backgroundColor: "#E99D00",
                activeOpacity: 0.5,
                activeBackgroundColor: "#E99D00",
                disabled: false,
                deletable: true
            },
            pageBreak: {
                font: "Microsoft YaHei",
                fontSize: 12,
                lineDash: [3, 1]
            },
            background: {
                color: "#FFFFFF",
                image: "",
                size: "cover",
                repeat: "no-repeat",
                applyPageNumbers: []
            },
            lineBreak: {
                disabled: true,
                color: "#CCCCCC",
                lineWidth: 1.5
            },
            separator: {
                lineWidth: 1,
                strokeStyle: "#000000"
            },
            lineNumber: {
                size: 12,
                font: "Microsoft YaHei",
                color: "#000000",
                disabled: true,
                right: 20,
                type: "continuity"
            },
            pageBorder: {
                color: "#000000",
                lineWidth: 1,
                padding: [0, 5, 0, 5],
                disabled: true
            },
            badge: {
                top: 0,
                left: 5
            },
            modeRule: {
                print: {
                    imagePreviewerDisabled: false
                },
                readonly: {
                    imagePreviewerDisabled: false
                },
                form: {
                    controlDeletableDisabled: false
                }
            }
        }
    );

    // æ³¨å†Œæ’ä»¶
    instance.use(barcode1dPlugin);
    instance.use(barcode2dPlugin);
    instance.use(codeblockPlugin);
    instance.use(docxPlugin);
    instance.use(excelPlugin);
    instance.use(floatingToolbarPlugin);
    instance.use(diagramPlugin);
    instance.use(casePlugin);

    // ä¿å­˜ç¼–è¾‘å™¨å®ä¾‹
    editorInstance = instance;

    // æ³¨å†Œå³é”®èœå•
    instance.register.contextMenuList([
        {
            name: 'æ’å…¥æ¡å½¢ç ',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const content = window.prompt('è¯·è¾“å…¥å†…å®¹');
                command.executeInsertBarcode1D(content, 200, 100);
            }
        },
        {
            name: 'æ’å…¥äºŒç»´ç ',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const content = window.prompt('è¯·è¾“å…¥å†…å®¹');
                command.executeInsertBarcode2D(content, 200, 200);
            }
        },
        {
            name: 'æ’å…¥ä»£ç å—',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const content = window.prompt('è¯·è¾“å…¥ä»£ç å†…å®¹');
                const language = window.prompt('è¯·è¾“å…¥ç¼–ç¨‹è¯­è¨€ (å¦‚: javascript, python, html)');
                command.executeInsertCodeblock(content, language);
            }
        },
        {
            name: 'æ’å…¥åˆ†é¡µç¬¦',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                command.executeInsertPageBreak();
            }
        },
        {
            name: 'æ’å…¥æ—¥æœŸé€‰æ‹©å™¨',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                command.executeInsertDatePicker();
            }
        },
        {
            name: 'æ’å…¥å•é€‰æ¡†',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const options = window.prompt('è¯·è¾“å…¥é€‰é¡¹ï¼Œç”¨é€—å·åˆ†éš” (å¦‚: é€‰é¡¹1,é€‰é¡¹2,é€‰é¡¹3)');
                if (options) {
                    const optionList = options.split(',');
                    command.executeInsertRadio(optionList);
                }
            }
        },
        {
            name: 'æ’å…¥å¤é€‰æ¡†',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const options = window.prompt('è¯·è¾“å…¥é€‰é¡¹ï¼Œç”¨é€—å·åˆ†éš” (å¦‚: é€‰é¡¹1,é€‰é¡¹2,é€‰é¡¹3)');
                if (options) {
                    const optionList = options.split(',');
                    command.executeInsertCheckbox(optionList);
                }
            }
        },
        {
            name: 'æ’å…¥æ–‡æœ¬æ¡†',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: command => {
                const placeholder = window.prompt('è¯·è¾“å…¥å ä½ç¬¦æ–‡æœ¬');
                command.executeInsertInput(placeholder);
            }
        },
        {
            isDivider: true
        },
        {
            name: 'å¯¼å‡ºWordæ–‡æ¡£',
            when: payload => true,
            callback: command => {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                command.executeExportDocx({
                    fileName: `canvas-editor-${timestamp}.docx`
                });
            }
        },
        {
            name: 'å¯¼å…¥Wordæ–‡æ¡£',
            when: payload => true,
            callback: command => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.docx';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        command.executeImportDocx({
                            file
                        });
                    }
                };
                input.click();
            }
        },
        {
            name: 'å¯¼å…¥Excelæ–‡æ¡£',
            when: payload => true,
            callback: command => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        command.executeImportExcel({
                            file
                        });
                    }
                };
                input.click();
            }
        },
        {
            isDivider: true
        },
        {
            name: 'æ‰“å¼€/ç¼–è¾‘æµç¨‹å›¾',
            when: payload => {
                return !payload.isReadonly && payload.editorTextFocus;
            },
            callback: (command, context) => {
                const extension = context.startElement?.extension;
                const data = extension?.name === 'diagram' ? extension.xml : '';
                command.executeLoadDiagram({
                    data,
                    onDestroy: message => {
                        if (!message || !message.data) return;
                        const { bounds } = message;
                        if (!data) {
                            // æ–°å¢
                            command.executeInsertElementList([
                                {
                                    type: ElementType.IMAGE,
                                    width: bounds.width,
                                    height: bounds.height,
                                    value: message.data,
                                    extension: {
                                        name: 'diagram',
                                        xml: message.xml
                                    }
                                }
                            ]);
                        } else {
                            // æ›´æ–°
                            command.executeUpdateElementById({
                                id: context.startElement.id,
                                properties: {
                                    width: bounds.width,
                                    height: bounds.height,
                                    value: message.data,
                                    extension: {
                                        name: 'diagram',
                                        xml: message.xml
                                    }
                                }
                            });
                        }
                    }
                });
            }
        },
        {
            isDivider: true
        },
        {
            name: 'è½¬æˆå¤§å†™',
            when: payload => {
                return !payload.isReadonly && payload.editorHasSelection;
            },
            callback: command => {
                command.executeUpperCase();
            }
        },
        {
            name: 'è½¬æˆå°å†™',
            when: payload => {
                return !payload.isReadonly && payload.editorHasSelection;
            },
            callback: command => {
                command.executeLowerCase();
            }
        },
        {
            isDivider: true
        },
        {
            name: 'åˆ‡æ¢ç¼–è¾‘/åªè¯»æ¨¡å¼',
            when: payload => true,
            callback: command => {
                editorStatus.mode = editorStatus.mode === 'edit' ? 'readonly' : 'edit';
                command.executeSetMode(editorStatus.mode);
            }
        }
    ]);

    // æ³¨å†Œå¿«æ·é”®
    instance.register.shortcutKeyList([
        {
            key: 'ctrl+s',
            when: payload => true,
            callback: command => {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                command.executeExportDocx({
                    fileName: `canvas-editor-${timestamp}.docx`
                });
            }
        },
        {
            key: 'ctrl+p',
            when: payload => true,
            callback: command => {
                command.executePrint();
            }
        },
        {
            key: 'ctrl+b',
            when: payload => !payload.isReadonly,
            callback: command => {
                command.executeBold();
            }
        },
        {
            key: 'ctrl+i',
            when: payload => !payload.isReadonly,
            callback: command => {
                command.executeItalic();
            }
        },
        {
            key: 'ctrl+u',
            when: payload => !payload.isReadonly,
            callback: command => {
                command.executeUnderline();
            }
        },
        {
            key: 'ctrl+z',
            when: payload => !payload.isReadonly,
            callback: command => {
                command.executeUndo();
            }
        },
        {
            key: 'ctrl+y',
            when: payload => !payload.isReadonly,
            callback: command => {
                command.executeRedo();
            }
        }
    ]);

    // ç›‘å¬ç¼–è¾‘å™¨äº‹ä»¶
    instance.listener.valueChange = () => {
        editorStatus.isDirty = true;
        updateStatus();
    };

    // åˆå§‹åŒ–å®Œæˆ
    editorStatus.isLoading = false;
    updateStatus();
});

// æå–ç›®å½•
function extractTableOfContents() {
    if (!editorInstance) return;
    
    // æ¸…ç©ºç°æœ‰ç›®å½•
    tableOfContents.value = [];
    
    // è·å–ç¼–è¾‘å™¨å†…å®¹
    const content = editorInstance.command.getValue();
    
    // æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºæ•°ç»„
    if (Array.isArray(content)) {
        // éå†å†…å®¹æ•°ç»„ï¼ŒæŸ¥æ‰¾æ ‡é¢˜å…ƒç´ 
        let idCounter = 1;
        content.forEach(item => {
            if (item.type === ElementType.HEADING && item.level && item.level <= 3) {
                tableOfContents.value.push({
                    id: `heading-${idCounter++}`,
                    level: item.level,
                    text: item.value || ''
                });
            }
        });
    } else {
        // å¦‚æœå†…å®¹ä¸æ˜¯æ•°ç»„ï¼Œå°è¯•ä½¿ç”¨HTMLè§£æ
        const headingRegex = /<h([1-6])[^>]*>(.*?)<\/h[1-6]>/gi;
        let match;
        let idCounter = 1;
        
        while ((match = headingRegex.exec(content)) !== null) {
            const level = parseInt(match[1]);
            const text = match[2].replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
            
            // åªæå–H1-H3çº§åˆ«çš„æ ‡é¢˜
            if (level <= 3) {
                tableOfContents.value.push({
                    id: `heading-${idCounter++}`,
                    level: level,
                    text: text
                });
            }
        }
    }
}

// æ»šåŠ¨åˆ°æŒ‡å®šæ ‡é¢˜
function scrollToHeading(headingId) {
    if (!editorInstance) return;
    
    // ä»headingIdä¸­æå–æ ‡é¢˜ç´¢å¼•
    const indexMatch = headingId.match(/heading-(\d+)/);
    if (!indexMatch) return;
    
    const headingIndex = parseInt(indexMatch[1]) - 1;
    if (headingIndex < 0 || headingIndex >= tableOfContents.value.length) return;
    
    const targetHeading = tableOfContents.value[headingIndex];
    
    // è·å–ç¼–è¾‘å™¨å†…å®¹
    const content = editorInstance.command.getValue();
    
    if (Array.isArray(content)) {
        // æŸ¥æ‰¾ç›®æ ‡æ ‡é¢˜åœ¨å†…å®¹æ•°ç»„ä¸­çš„ä½ç½®
        let headingCount = 0;
        for (let i = 0; i < content.length; i++) {
            const item = content[i];
            if (item.type === ElementType.HEADING && item.level && item.level <= 3) {
                if (headingCount === headingIndex) {
                    // æ‰¾åˆ°ç›®æ ‡æ ‡é¢˜ï¼Œå°è¯•æ»šåŠ¨åˆ°è¯¥ä½ç½®
                    // ç”±äºcanvas-editorçš„APIé™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•
                    
                    // æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨ç¼–è¾‘å™¨çš„æ»šåŠ¨APIï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (editorInstance.command.scrollToElement) {
                        editorInstance.command.scrollToElement(i);
                        return;
                    }
                    
                    // æ–¹æ³•2ï¼šå°†å…‰æ ‡ç§»åŠ¨åˆ°æ ‡é¢˜ä½ç½®ï¼Œè¿™å¯èƒ½ä¼šè‡ªåŠ¨æ»šåŠ¨è§†å›¾
                    if (editorInstance.command.setCursorPosition) {
                        editorInstance.command.setCursorPosition(i, 0);
                        return;
                    }
                    
                    // æ–¹æ³•3ï¼šå¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸å¯ç”¨ï¼Œè®°å½•æ—¥å¿—
                    console.log(`æ‰¾åˆ°ç›®æ ‡æ ‡é¢˜: ${targetHeading.text} (ä½ç½®: ${i})`);
                    return;
                }
                headingCount++;
            }
        }
    }
    
    console.log(`æœªæ‰¾åˆ°æ ‡é¢˜: ${headingId}`);
}

// æ›´æ–°çŠ¶æ€ä¿¡æ¯
function updateStatus() {
    if (!editorInstance) return;
    
    // è·å–ç¼–è¾‘å™¨å†…å®¹
    const content = editorInstance.command.getValue();
    
    // æ›´æ–°å­—æ•°ç»Ÿè®¡
    let plainText = '';
    if (Array.isArray(content)) {
        // å¦‚æœå†…å®¹æ˜¯æ•°ç»„ï¼Œéå†æ‰€æœ‰å…ƒç´ æå–æ–‡æœ¬
        content.forEach(item => {
            if (item.value) {
                plainText += item.value;
            }
        });
    } else {
        // å¦‚æœå†…å®¹ä¸æ˜¯æ•°ç»„ï¼Œç›´æ¥æå–æ–‡æœ¬
        plainText = content.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ');
    }
    
    wordCount.value = plainText.trim().length;
    
    // æ›´æ–°é¡µç ä¿¡æ¯ï¼ˆè¿™é‡Œä½¿ç”¨ç®€å•ä¼°ç®—ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´ç²¾ç¡®çš„è®¡ç®—ï¼‰
    // å‡è®¾æ¯é¡µå¤§çº¦1000ä¸ªå­—ç¬¦
    const estimatedCharsPerPage = 1000;
    pageCount.value = Math.max(1, Math.ceil(wordCount.value / estimatedCharsPerPage));
    
    // æ›´æ–°ç›®å½•
    extractTableOfContents();
}
</script>

<style scoped>
/* å®¹å™¨æ ·å¼ */
.canvas-editor-container {
    height: calc(100vh - 60px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
    background: #f5f5f5;
    font-family: 'Microsoft YaHei', sans-serif;
    padding: 0;
    display: flex;
    flex-direction: column;
}

.editor-toolbar {
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.editor-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.sidebar-left {
    width: 25%;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    background-color: #f9f9f9;
}

.editor-main {
    width: 50%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-right {
    width: 25%;
    border-left: 1px solid #ddd;
    overflow-y: auto;
    background-color: #f9f9f9;
}

.sidebar-header {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    background-color: #f0f0f0;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.toc-container {
    padding: 10px;
}

.toc-list {
    list-style-type: none;
    padding-left: 0;
    margin: 0;
}

.toc-item {
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
    margin-bottom: 2px;
}

.toc-item:hover {
    background-color: #e6e6e6;
}

.toc-level-1 {
    font-weight: bold;
    padding-left: 10px;
}

.toc-level-2 {
    font-weight: normal;
    padding-left: 20px;
}

.toc-level-3 {
    font-weight: normal;
    padding-left: 30px;
    font-size: 0.9em;
}

.comments-container {
    padding: 10px;
}

.toolbar-group {
    display: flex;
    align-items: center;
    margin-right: 8px;
}

.toolbar-divider {
    width: 1px;
    height: 24px;
    background: #e0e0e0;
    margin: 0 8px;
}

.toolbar-btn {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 6px 8px;
    margin: 0 2px;
    cursor: pointer;
    color: #333;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 32px;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: #f5f5f5;
    border-color: #d0d0d0;
}

.toolbar-btn:active {
    background: #e0e0e0;
}

/* ç¼–è¾‘å™¨æ ·å¼ */
.editor {
    flex: 1;
    background: white;
    overflow: auto;
}

/* çŠ¶æ€æ æ ·å¼ */
.editor-statusbar {
    background: #f5f5f5;
    border-top: 1px solid #e0e0e0;
    padding: 6px 16px;
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #666;
}

.status-item {
    margin-right: 16px;
}

/* å›¾æ ‡æ ·å¼ - ä½¿ç”¨ç®€å•çš„Unicodeå­—ç¬¦ä»£æ›¿å›¾æ ‡ */
.icon-undo::before {
    content: 'â†¶';
}
.icon-redo::before {
    content: 'â†·';
}
.icon-bold::before {
    content: 'B';
    font-weight: bold;
}
.icon-italic::before {
    content: 'I';
    font-style: italic;
}
.icon-underline::before {
    content: 'U';
    text-decoration: underline;
}
.icon-align-left::before {
    content: 'â—€';
}
.icon-align-center::before {
    content: 'â—†';
}
.icon-align-right::before {
    content: 'â–¶';
}
.icon-list-ul::before {
    content: 'â€¢';
}
.icon-list-ol::before {
    content: '1.';
}
.icon-table::before {
    content: 'âŠ';
}
.icon-image::before {
    content: 'ğŸ–¼';
}
.icon-link::before {
    content: 'ğŸ”—';
}
.icon-file-word::before {
    content: 'W';
}
.icon-file-pdf::before {
    content: 'P';
}
.icon-file-excel::before {
    content: 'E';
}
.icon-barcode::before {
    content: 'â§';
}
.icon-qrcode::before {
    content: 'âš';
}
.icon-code::before {
    content: '</>';
}
.icon-page-break::before {
    content: 'â';
}
.icon-calendar::before {
    content: 'ğŸ“…';
}
.icon-diagram::before {
    content: 'â¬¡';
}
.icon-radio::before {
    content: 'âŠ™';
}
.icon-checkbox::before {
    content: 'â˜‘';
}
.icon-input::before {
    content: 'â–­';
}
.icon-uppercase::before {
    content: 'AA';
}
.icon-lowercase::before {
    content: 'aa';
}
.icon-mode::before {
    content: 'âœ';
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .toolbar-group {
        margin-bottom: 4px;
    }

    .editor-toolbar {
        padding: 6px 8px;
    }

    .toolbar-btn {
        min-width: 28px;
        height: 28px;
        padding: 4px 6px;
        font-size: 12px;
    }
}
</style>
